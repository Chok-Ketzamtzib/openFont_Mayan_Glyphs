%==========================================================================
%   mpfmap.tex    part of mayaps project version 1.0 November 23, 2012
%
%   Author:       Stepan Orevkov   orevkov(a)math.ups-tlse.fr
%
%   Changes:
%
%   version 0.32  1. \mfont is added (unless it works only with codex.mpf)
%                 2. The comment added in map.tmp and mapsubs.tmp
%
%   version 0.33  1. \mayaGlyphCC is used for making mapsubs.tmp
%
%   version 0.37  1. \input mayaps is placed in the beginning with checking
%                    if it is already loaded.
%                    Now several \mpfmap can be issued from the same file.
%                 2. \smallskip after \input mpfmap.tmp
%                 3. percent signs are added somewhere to avoid extra spaces
%
%   version 0.38  1. Version and section names may be added into mpf file as
%                    %V@  version info
%                    %M@  title
%
%   version 1.0   1  \maya@percent is replaced by \maya@P (see mayaps.tex v 1.0)
%
\ifx\mayaGlyphInLine\mpfmapundefined  % check if mayaps.tex is loaded
  \input mayaps
\fi
\catcode`\@=11
%
\newcount\mpfmapN \mpfmapN=7   % the number of glyphs per line
%
\newread \mpfmap@i
\newwrite\mpfmap@m
\newwrite\mpfmap@s
\newcount\mpfmap@nm
\newcount\mpfmap@ns
\newif\ifmpfmap@OK
\newif\ifmpfmap@hdr
%\newtoks\mpfmap@version
\font\mpfmap@big=cmbx12
\font\mpfmap@bigtt=cmtt12
%
\begingroup
\catcode`\<=1
\catcode`\>=2
\catcode`\{=12
\catcode`\}=12
\xdef\lbrace<{>\xdef\rbrace<}>
\endgroup
%
{\catcode`\%=12 \global\def\percent{%}}%
%
\def\mpfmap#1{%
   \mpfmap@nm=0 \mpfmap@ns=0 \mpfmap@hdrtrue
   \immediate\openin \mpfmap@i=#1.mpf
   \immediate\openout\mpfmap@m=map.tmp
   \immediate\openout\mpfmap@s=mapsubs.tmp
   \immediate\write\mpfmap@m{\percent\space map.tmp - map of #1.mpf}
   \immediate\write\mpfmap@m{\percent\space file generated by mpfmap v 1.0}
   \immediate\write\mpfmap@s{\percent\space mapsubs.tmp - substitution table of #1.mpf}
   \immediate\write\mpfmap@s{\percent\space file generated by mpfmap v 1.0}
   \mpfmap@
   \ifnum\mpfmap@nm>0\immediate\write\mpfmap@m{\rbrace\par}\fi
   \immediate\closein \mpfmap@i
   \immediate\closeout\mpfmap@m
   \immediate\closeout\mpfmap@s
   \mayaFont\mfont=#1
   \mfont
   \mayahskip=9pt plus 3pt minus 3pt
   \smallskip\centerline{\mpfmap@big Map of Maya Font {\mpfmap@bigtt #1} \mpfmap@version}
   \medskip  \centerline{\mpfmap@big Primitive Glyphs}\medskip\noindent
   \input map.tmp
   \bigskip  \centerline{\mpfmap@big Substitutions (ligatures)}\nobreak
   \medskip\nobreak\noindent
   \input mapsubs.tmp
   \smallskip
}
\def\hs{\hskip 15pt plus 6pt minus 6pt}
\def\mpfmap@{% similar to \maya@io  (mayaps.tex)
        \xdef\mpfmap@version{}
        {%                      %"start a group to contain catcode changes
            \mpfmap@OKtrue         %"true while we are looping
            %" Make all special characters, except space, to be of type
            %" `other' so we process the file in almost verbatim mode
            %" (TeXbook, p. 344).
            \chardef\other=12
            \def\do##1{\catcode`##1=\other}% space \ { } $ & # ^ ^K ^A % ~
            \dospecials
            \catcode`\ =10 \catcode`\@=11
            \loop                 %"reading lines from the mpf file
                \read\mpfmap@i to \mpfmap@line 
                \ifeof\mpfmap@i         %"then no more input
                    \mpfmap@OKfalse    %"so set completion flag
                \else                 %"otherwise process one line
                    \expandafter\mpfmap@aux\mpfmap@line . . . . . \\%
                \fi
            \ifmpfmap@OK
            \repeat
        }%                      %"end catcode changes
}
%
{\catcode`\%=12 \global\let\maya@P=%}%
%
% this macro is used in \mpfmap@
%
\long\def\mpfmap@aux#1#2 #3 #4 \\{%
    \ifx#1\maya@P\def\a{@}\def\b{#2}% if #1 == %
        \ifx\a\b                          % if #2 == @
            \def\a{.}\def\b{#3}
            \ifx\a\b                      % if #3 is empty
                \mpfmap@hdrfalse
            \else                         % if #3 is nonempty
                \ifnum\mpfmap@nm=0
                    \immediate\write\mpfmap@m{\noexpand\mayaC\lbrace}
                \fi
                \immediate\write\mpfmap@m{#3 }\global\advance\mpfmap@nm by 1
                \ifnum\mpfmap@nm=\mpfmapN\global\mpfmap@nm=0
                    \immediate\write\mpfmap@m{\rbrace\par}
                \fi
            \fi
        \else
            \def\a{L@}                    % if #2 == L@
            \ifx\a\b
                \immediate\write\mpfmap@s{%
                    \noexpand\mayaGlyphCC\lbrace#3\rbrace\noexpand\hs}
                \advance\mpfmap@ns by 1
                \ifnum\mpfmap@ns=\mpfmapN\global\mpfmap@ns=0
                    \immediate\write\mpfmap@s{\noexpand\smallskip\noindent}
                \fi
            \else
                \def\a{M@}                    % if #2 == M@
                \ifx\a\b
                    \ifmpfmap@hdr
                        \global\mpfmap@ns=0
                    \else
                        \ifnum\mpfmap@nm>0
                            \immediate\write\mpfmap@m{\rbrace\par}
                        \fi
                        \global\mpfmap@nm=0
                    \fi
                    \immediate\write\ifmpfmap@hdr\mpfmap@s\else\mpfmap@m\fi{%
                        \noexpand\medskip\noexpand\centerline\lbrace
                        \noexpand\bf\mpfmap@auxM#3 #4 @@\rbrace
                        \noexpand\nobreak\noexpand\medskip}%
                    \ifmpfmap@hdr
                        \immediate\write\mpfmap@s{\noindent}
                    \fi
                \else
                    \def\a{V@}                    % if #2 == V@
                    \ifx\a\b
                        \xdef\mpfmap@version{\mpfmap@auxM#3 #4 @@}
                    \fi
                \fi
            \fi
        \fi
    \fi
}%
\def\mpfmap@auxM#1 . #2 @@{#1}
\catcode`\@=12
\endinput